<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>角色移动演示</title>
    <style>
        body {
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #f0f0f0;
        }
        #gameContainer {
            position: relative;
            width: 1000px;
            height: 1000px;
            border: 2px solid #333;
            background-image: linear-gradient(#ccc 1px, transparent 1px),
                            linear-gradient(90deg, #ccc 1px, transparent 1px);
            background-size: 50px 50px;
        }
        #mapImage {
            position: absolute;
            width: 100%;
            height: 100%;
            z-index: -1;
        }
        #player {
            position: absolute;
            width: 150px;
            height: 150px;
            background-size: contain;
            background-repeat: no-repeat;
            transition: left 0.5s linear, top 0.5s linear;
            filter: drop-shadow(3px 3px 3px rgba(0,0,0,0.3));
            transform: translate(-75px, -75px);
            z-index: 1;
        }
        .portal {
            position: absolute;
            width: 50px;
            height: 50px;
            background-color: rgba(0, 255, 255, 0.3);
            border: 2px solid cyan;
            border-radius: 50%;
            transform: translate(-25px, -25px);
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <img id="mapImage" src="map/main.bmp" alt="地图" onerror="handleImageError(this)" onload="handleImageLoad(this)">
        <div id="player"></div>
        <div id="debug" style="position: absolute; top: 10px; left: 10px; color: black; z-index: 2; background: rgba(255,255,255,0.7); padding: 5px;"></div>
    </div>
    <script>
        // 添加全局图片错误处理
        function handleImageError(img) {
            console.error('图片加载失败:', img.src);
            document.getElementById('debug').textContent += '\n图片加载失败: ' + img.src;
        }

        function handleImageLoad(img) {
            console.log('图片加载成功:', img.src);
        }

        class Game {
            constructor() {
                this.player = document.getElementById('player');
                this.mapImage = document.getElementById('mapImage');
                this.debug = document.getElementById('debug');
                this.currentMap = 'main';
                this.moveDistance = 50;
                this.isMoving = false;
                this.isAttacking = false;
                
                // 修改地图文件扩展名
                this.maps = {
                    main: { file: 'main.bmp', name: '主地图' },
                    u: { file: 'u.bmp', name: '上方地图' },
                    d: { file: 'd.bmp', name: '下方地图' },
                    l: { file: 'l.bmp', name: '左侧地图' },
                    r: { file: 'r.bmp', name: '右侧地图' }
                };

                // 调整传送门位置和触发范围
                this.portals = {
                    main: [
                        { x: 500, y: 100, target: 'u', spawnAt: { x: 500, y: 800 } },
                        { x: 500, y: 900, target: 'd', spawnAt: { x: 500, y: 200 } },
                        { x: 100, y: 500, target: 'l', spawnAt: { x: 800, y: 500 } },
                        { x: 900, y: 500, target: 'r', spawnAt: { x: 200, y: 500 } }
                    ],
                    u: [{ x: 500, y: 900, target: 'main', spawnAt: { x: 500, y: 200 } }],
                    d: [{ x: 500, y: 100, target: 'main', spawnAt: { x: 500, y: 800 } }],
                    l: [{ x: 900, y: 500, target: 'main', spawnAt: { x: 200, y: 500 } }],
                    r: [{ x: 100, y: 500, target: 'main', spawnAt: { x: 800, y: 500 } }]
                };

                this.playerPos = { x: 500, y: 500 };
                this.init();
            }

            init() {
                try {
                    this.player.style.backgroundImage = "url('person/stay.gif')";
                    this.updatePlayerPosition();
                    this.createPortals();
                    this.updateDebugInfo();
                    
                    // 绑定键盘事件
                    document.addEventListener('keydown', this.handleKeyPress.bind(this));
                    
                    // 添加地图加载事件
                    this.mapImage.addEventListener('load', () => {
                        console.log('地图加载成功:', this.currentMap);
                        this.updateDebugInfo();
                    });

                    this.mapImage.addEventListener('error', () => {
                        console.error('地图加载失败:', this.currentMap);
                        this.updateDebugInfo();
                    });
                } catch (error) {
                    console.error('初始化错误:', error);
                    this.debug.textContent = '初始化错误: ' + error.message;
                }
            }

            updateDebugInfo() {
                const debugInfo = [
                    `当前地图: ${this.maps[this.currentMap].name}`,
                    `位置: (${this.playerPos.x}, ${this.playerPos.y})`,
                    `地图文件: ${this.maps[this.currentMap].file}`,
                    `图片路径: ${this.mapImage.src}`
                ];
                this.debug.textContent = debugInfo.join('\n');
            }

            createPortals() {
                // 清除现有的传送门
                document.querySelectorAll('.portal').forEach(portal => portal.remove());
                
                // 创建当前地图的传送门
                this.portals[this.currentMap].forEach(portal => {
                    const portalElement = document.createElement('div');
                    portalElement.className = 'portal';
                    portalElement.style.left = `${portal.x}px`;
                    portalElement.style.top = `${portal.y}px`;
                    document.getElementById('gameContainer').appendChild(portalElement);
                });
            }

            changeMap(targetMap, spawnPos) {
                try {
                    console.log(`准备切换地图: ${this.currentMap} -> ${targetMap}`);
                    
                    // 检查目标地图是否有效
                    if (!this.maps[targetMap]) {
                        throw new Error(`无效的地图: ${targetMap}`);
                    }

                    const oldMap = this.currentMap;
                    this.currentMap = targetMap;
                    
                    // 构建完整的图片URL
                    const mapUrl = `map/${this.maps[targetMap].file}`;
                    console.log('加载地图:', mapUrl);
                    
                    // 更新地图图片
                    this.mapImage.src = mapUrl;
                    
                    // 更新玩家位置
                    this.playerPos = { x: spawnPos.x, y: spawnPos.y };
                    this.updatePlayerPosition();
                    this.createPortals();
                    this.updateDebugInfo();
                    
                    console.log(`地图切换完成: ${oldMap} -> ${targetMap}`);
                } catch (error) {
                    console.error('切换地图错误:', error);
                    this.debug.textContent += '\n切换地图错误: ' + error.message;
                }
            }

            checkPortals() {
                const portals = this.portals[this.currentMap];
                for (let portal of portals) {
                    const dx = this.playerPos.x - portal.x;
                    const dy = this.playerPos.y - portal.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < 75) {  // 增加传送门触发范围
                        console.log(`触发传送: ${this.currentMap} -> ${portal.target}`);
                        this.changeMap(portal.target, portal.spawnAt);
                        break;
                    }
                }
            }

            updatePlayerPosition() {
                this.player.style.left = `${this.playerPos.x}px`;
                this.player.style.top = `${this.playerPos.y}px`;
                this.checkPortals();
                this.updateDebugInfo();
            }

            handleKeyPress(e) {
                if (this.isMoving || this.isAttacking) return;

                switch(e.key) {
                    case 'ArrowUp': this.move('up'); break;
                    case 'ArrowDown': this.move('down'); break;
                    case 'ArrowLeft': this.move('left'); break;
                    case 'ArrowRight': this.move('right'); break;
                    case ' ': this.attack(); break;
                }
            }

            move(direction) {
                if (this.isMoving) return;

                let newX = this.playerPos.x;
                let newY = this.playerPos.y;
                let imageName = '';

                switch(direction) {
                    case 'up':
                        newY -= this.moveDistance;
                        imageName = 'u.gif';
                        break;
                    case 'down':
                        newY += this.moveDistance;
                        imageName = 'd.gif';
                        break;
                    case 'left':
                        newX -= this.moveDistance;
                        imageName = 'l.gif';
                        break;
                    case 'right':
                        newX += this.moveDistance;
                        imageName = 'r.gif';
                        break;
                }

                // 调整边界检查范围
                if (newX >= 100 && newX <= 900 && newY >= 100 && newY <= 900) {
                    this.isMoving = true;
                    this.player.style.backgroundImage = `url('person/${imageName}')`;
                    this.playerPos = { x: newX, y: newY };
                    this.updatePlayerPosition();

                    setTimeout(() => {
                        this.isMoving = false;
                        this.player.style.backgroundImage = "url('person/stay.gif')";
                    }, 500);
                }
            }

            attack() {
                if (this.isAttacking) return;
                
                this.isAttacking = true;
                this.player.style.backgroundImage = "url('person/att.gif')";
                
                setTimeout(() => {
                    this.isAttacking = false;
                    this.player.style.backgroundImage = "url('person/stay.gif')";
                }, 500);
            }
        }

        window.onload = () => {
            try {
                window.game = new Game();
            } catch (error) {
                console.error('游戏启动错误:', error);
                document.getElementById('debug').textContent = '游戏启动错误: ' + error.message;
            }
        };
    </script>
</body>
</html>
